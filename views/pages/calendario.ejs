<div class="container my-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card p-4">
                <h2 class="mb-3" style="color: #8D40A4; font-weight: bold;">Calendário</h2>
                <table class="table table-bordered text-center align-middle" style="background: #fff;">
                    <thead>
                        <tr style="background: #f5e6ff;">
                            <th>Dom</th>
                            <th>Seg</th>
                            <th>Ter</th>
                            <th>Qua</th>
                            <th>Qui</th>
                            <th>Sex</th>
                            <th>Sáb</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCalendario">
                        <!-- Dias do calendário serão inseridos via JavaScript -->
                    </tbody>
                </table>
                <div class="d-flex gap-3 mt-2">
                    <span><span style="display:inline-block;width:18px;height:18px;background:#4CAF50;border-radius:4px;margin-right:4px;"></span>Disponível</span>
                    <span><span style="display:inline-block;width:18px;height:18px;background:#F44336;border-radius:4px;margin-right:4px;"></span>Indisponível</span>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-4">
                <h3 class="h5 mb-3" style="color: #8D40A4; font-weight: bold;">Selecionar horário:</h3>
                <select class="form-select mb-3" id="horarioSelect">
                    <option value="8:00">8:00</option>
                    <option value="9:00">9:00</option>
                    <option value="10:00">10:00</option>
                    <option value="11:00">11:00</option>
                    <option value="12:00">12:00</option>
                    <option value="13:00">13:00</option>
                    <option value="14:00">14:00</option>
                    <option value="15:00">15:00</option>
                    <option value="16:00">16:00</option>
                    <option value="17:00">17:00</option>
                    <option value="18:00">18:00</option>
                </select>
                <button class="btn btn-primary w-100" onclick="selecionarHorario()">Selecionar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    const tabela = document.getElementById('tabelaCalendario');
    const hoje = new Date();
    const mes = hoje.getMonth();
    const ano = hoje.getFullYear();
    const primeiroDia = new Date(ano, mes, 1);
    const ultimoDia = new Date(ano, mes + 1, 0);
    let diaSemana = primeiroDia.getDay();
    let linha = document.createElement('tr');

    // Pegue o roomId do localStorage ou de outra fonte
    const roomId = localStorage.getItem('salaSelecionada');
    // Formate datas para o período do mês
    const start = `${ano}-${String(mes+1).padStart(2, '0')}-01`;
    const end = `${ano}-${String(mes+1).padStart(2, '0')}-${String(ultimoDia.getDate()).padStart(2, '0')}`;

    // Busque reservas reais do banco (se houver sala selecionada)
    let reservas = [];
    if (roomId) {
        try {
            const res = await fetch(`/api/bookings/sala/${roomId}?start=${start}&end=${end}`);
            reservas = await res.json();
        } catch (e) {
            reservas = [];
        }
    }

    // Função para checar se o dia/horário está reservado
    function isDiaHorarioReservado(dia, horario) {
        const dataDia = new Date(ano, mes, dia);
        return reservas.some(r => {
            const inicio = new Date(r.data_inicio);
            const fim = new Date(r.data_fim);
            // Se o dia está entre o início e o fim da reserva
            return (
                dataDia.getFullYear() === inicio.getFullYear() &&
                dataDia.getMonth() === inicio.getMonth() &&
                dataDia.getDate() === inicio.getDate()
            );
        });
    }

    // Preenche os dias vazios do início
    for (let i = 0; i < diaSemana; i++) {
        linha.appendChild(document.createElement('td'));
    }

    // Variável global para armazenar o dia selecionado
    window.diaSelecionadoCalendario = null;

    for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
        const td = document.createElement('td');
        td.textContent = dia;

        // Verifica se o dia está reservado para qualquer horário
        if (roomId && isDiaHorarioReservado(dia)) {
            td.style.background = '#F44336';
            td.style.color = '#fff';
            td.classList.add('indisponivel');
        } else {
            td.style.background = '#4CAF50';
            td.style.color = '#fff';
            td.style.cursor = 'pointer';
            td.classList.add('disponivel');
            td.onclick = function() {
                // Remove seleção anterior
                document.querySelectorAll('.disponivel.selecionado').forEach(d => {
                    d.classList.remove('selecionado');
                    d.style.outline = '';
                });
                td.classList.add('selecionado');
                td.style.outline = '3px solid #692D7E';
                td.style.outlineOffset = '2px';
                window.diaSelecionadoCalendario = dia;
                window.atualizarHorariosDisponiveis(dia);
            };
        }
        td.style.fontWeight = 'bold';
        td.style.fontSize = '1.1em';
        td.style.borderRadius = '6px';
        linha.appendChild(td);
        diaSemana++;
        if (diaSemana > 6) {
            tabela.appendChild(linha);
            linha = document.createElement('tr');
            diaSemana = 0;
        }
    }
    // Preenche os dias vazios do final
    if (diaSemana !== 0) {
        for (let i = diaSemana; i < 7; i++) {
            linha.appendChild(document.createElement('td'));
        }
        tabela.appendChild(linha);
    }

    // Opcional: aviso se nenhuma sala foi selecionada
    if (!roomId) {
        const aviso = document.createElement('div');
        aviso.className = 'alert alert-warning mt-3';
        aviso.textContent = 'Selecione uma sala antes de visualizar o calendário.';
        tabela.parentElement.appendChild(aviso);
    }

    // Adicione este código para atualizar horários ao selecionar um dia
    window.atualizarHorariosDisponiveis = async function(diaSelecionado) {
        const roomId = localStorage.getItem('salaSelecionada');
        const ano = new Date().getFullYear();
        const mes = String(new Date().getMonth() + 1).padStart(2, '0');
        const dia = String(diaSelecionado).padStart(2, '0');
        const dataDia = `${ano}-${mes}-${dia}`;
        const res = await fetch(`/api/bookings/sala/${roomId}?start=${dataDia}&end=${dataDia}`);
        const reservas = await res.json();
        console.log('Reservas para o dia:', reservas);

        // Horários possíveis
        const horarios = [
            "08:00", "09:00", "10:00", "11:00", "12:00",
            "13:00", "14:00", "15:00", "16:00", "17:00", "18:00"
        ];

        // Filtra horários já reservados
        const horariosReservados = reservas.map(r => {
            const d = new Date(r.data_inicio);
            return d.toTimeString().slice(0,5);
        });

        const select = document.getElementById('horarioSelect');
        select.innerHTML = '';
        let algumDisponivel = false;
        horarios.forEach(horario => {
            if (!horariosReservados.includes(horario)) {
                const opt = document.createElement('option');
                opt.value = horario;
                opt.textContent = horario;
                select.appendChild(opt);
                algumDisponivel = true;
            }
        });
        if (!algumDisponivel) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Nenhum horário disponível';
            select.appendChild(opt);
        }
    };
});

function selecionarHorario() {
    const horarioSelect = document.getElementById('horarioSelect');
    const horario = horarioSelect.value;
    const diaSelecionado = window.diaSelecionadoCalendario;
    if (!diaSelecionado) {
        alert('Por favor, selecione um dia disponível primeiro.');
        return;
    }
    if (!horario || horario === '' || horario === 'Nenhum horário disponível') {
        alert('Por favor, selecione um horário disponível.');
        return;
    }
    localStorage.setItem('dataSelecionada', diaSelecionado);
    localStorage.setItem('horarioSelecionado', horario);
    window.location.href = '/detalhes';
}
</script>
